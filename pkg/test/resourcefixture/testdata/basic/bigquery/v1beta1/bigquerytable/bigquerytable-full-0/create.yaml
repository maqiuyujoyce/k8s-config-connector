# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: bigquery.cnrm.cloud.google.com/v1beta1
kind: BigQueryTable
metadata:
  name: bigquerytable-${uniqueId}
spec:
  datasetRef:
    name: bigquerydataset-${uniqueId}
  encryptionConfiguration:
    kmsKeyRef:
      name: kmscryptokey-${uniqueId}
    kmsKeyVersion: "gcp-kms-key-version-string-${uniqueId}"
  externalDataConfiguration:
    autodetect: false
    sourceUris:
      - "gs://my-bucket-${uniqueId}/my-file.csv"
    sourceFormat: "CSV" # Using CSV to enable csvOptions and schema
    schema: '[{"name":"colA","type":"STRING"},{"name":"colB","type":"INTEGER"}]'
    avroOptions:
      useAvroLogicalTypes: true
    compression: "GZIP"
    connectionId: "projects/${projectId}/locations/us-central1/connections/connection-${uniqueId}"
    csvOptions:
      allowJaggedRows: true
      allowQuotedNewlines: true
      encoding: "UTF-8"
      fieldDelimiter: ","
      quote: '"'
      skipLeadingRows: 1
    fileSetSpecType: "FILE_SYSTEM_MATCH"
    googleSheetsOptions:
      range: "sheet1!A1:Z100"
      skipLeadingRows: 1
    hivePartitioningOptions:
      mode: "AUTO"
      requirePartitionFilter: false
      sourceUriPrefix: "gs://my-bucket-${uniqueId}/my-hive-table/"
    ignoreUnknownValues: true
    jsonOptions: # Included per instruction, though sourceFormat is CSV
      encoding: "UTF-8"
    maxBadRecords: 5
    metadataCacheMode: "AUTOMATIC"
    parquetOptions: # Included per instruction, though sourceFormat is CSV
      enableListInference: true
      enumAsString: true
    referenceFileSchemaUri: "gs://my-bucket-${uniqueId}/schema_files/my_schema.json" # For AVRO, PARQUET, ORC
  maxStaleness: "INTERVAL 30 MINUTE"
  rangePartitioning:
    field: "myRangePartitionColumn"
    range:
      start: 0
      end: 1000
      interval: 100
