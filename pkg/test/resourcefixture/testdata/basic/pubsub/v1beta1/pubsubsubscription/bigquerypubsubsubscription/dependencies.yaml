# Copyright 2022 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: pubsub.cnrm.cloud.google.com/v1beta1
kind: PubSubSchema
metadata:
  name: pubsubschema-${uniqueId}
spec:
  type: PROTOCOL_BUFFER
  definition: "syntax = \"proto3\";\nmessage ProtoBuf {\nstring content = 1;\nint64 publish_time = 2;\n}"
#  definition: "syntax = \"proto3\";\nmessage ProtoBuf {\nstring content = 1;\nstring message_id = 2;\nint64 publish_time = 3;\nstring attributes = 4;\nstring subscription_name = 5;\n}"
#  type: AVRO
#  definition: >
#    {
#      "type" : "record",
#      "name" : "Avro",
#      "fields" : [
#        {
#          "name" : "content",
#          "type" : "string"
#        }
#      ]
#    }

  #        {
  #          "name" : "message_id",
  #          "type" : "string"
  #        },
  #        {
  #          "name" : "publish_time",
  #          "type" : "int"
  #        },
  #        {
  #          "name" : "attributes",
  #          "type" : "string"
  #        },
  #        {
  #          "name" : "subscription_name",
  #          "type" : "string"
  #        }
  projectRef:
    external: ${projectId}
---
apiVersion: pubsub.cnrm.cloud.google.com/v1beta1
kind: PubSubTopic
metadata:
  annotations:
    cnrm.cloud.google.com/project-id: ${projectId}
  name: pubsubtopic-${uniqueId}
spec:
  schemaSettings:
    schemaRef:
#      name: pubsubschema-${uniqueId}
       external: projects/maqiuyu-kcc-test-2/schemas/pubsubschema-25vjh6jx5nyohva
    encoding: JSON
---
apiVersion: iam.cnrm.cloud.google.com/v1beta1
kind: IAMPolicyMember
metadata:
  annotations:
    # Abandoning the IAMPolicyMember as the underlying IAM binding is shared by
    # TestAcquire and TestCreateNoChangeUpdateDelete, and shouldn't be deleted
    # when only one of the test finishes.
    cnrm.cloud.google.com/deletion-policy: "abandon"
  name: iampolicymember-1-${uniqueId}
spec:
  member: serviceAccount:service-${projectNumber}@gcp-sa-pubsub.iam.gserviceaccount.com
  role: roles/bigquery.metadataViewer
  resourceRef:
    apiVersion: resourcemanager.cnrm.cloud.google.com/v1beta1
    kind: Project
    external: projects/${projectId}
---
apiVersion: iam.cnrm.cloud.google.com/v1beta1
kind: IAMPolicyMember
metadata:
  annotations:
    # Abandoning the IAMPolicyMember as the underlying IAM binding is shared by
    # TestAcquire and TestCreateNoChangeUpdateDelete, and shouldn't be deleted
    # when only one of the test finishes.
    cnrm.cloud.google.com/deletion-policy: "abandon"
  name: iampolicymember-2-${uniqueId}
spec:
  member: serviceAccount:service-${projectNumber}@gcp-sa-pubsub.iam.gserviceaccount.com
  role: roles/bigquery.dataEditor
  resourceRef:
    apiVersion: resourcemanager.cnrm.cloud.google.com/v1beta1
    kind: Project
    external: projects/${projectId}
---
apiVersion: bigquery.cnrm.cloud.google.com/v1beta1
kind: BigQueryDataset
metadata:
  annotations:
    cnrm.cloud.google.com/project-id: ${projectId}
  name: bigquerydataset-${uniqueId}
spec:
  resourceID: bigquerydataset${uniqueId}
  location: us-central1
---
apiVersion: bigquery.cnrm.cloud.google.com/v1beta1
kind: BigQueryTable
metadata:
  annotations:
    cnrm.cloud.google.com/project-id: ${projectId}
  name: bigquerytable-1-${uniqueId}
spec:
  resourceID: bigquerytable1${uniqueId}
  friendlyName: bigquerytable-1-${uniqueId}
  datasetRef:
    name: bigquerydataset-${uniqueId}
  schema: '[{"name":"data","type":"STRING","mode":"NULLABLE","description":"The data"},{"name":"content","type":"STRING","mode":"NULLABLE"},{"name":"message_id","type":"STRING","mode":"REQUIRED"},{"name":"publish_time","type":"TIMESTAMP","mode":"REQUIRED"},{"name":"attributes","type":"STRING","mode":"REQUIRED"},{"name":"subscription_name","type":"STRING","mode":"REQUIRED"}]'
#  schema: '[{"name":"data","type":"STRING","mode":"NULLABLE","description":"The data"},{"name":"content","type":"STRING","mode":"NULLABLE"},{"name":"message_id","type":"STRING","mode":"REQUIRED"},{"name":"attributes","type":"STRING","mode":"REQUIRED"},{"name":"subscription_name","type":"STRING","mode":"REQUIRED"}]'
---
apiVersion: bigquery.cnrm.cloud.google.com/v1beta1
kind: BigQueryTable
metadata:
  annotations:
    cnrm.cloud.google.com/project-id: ${projectId}
  name: bigquerytable-2-${uniqueId}
spec:
  resourceID: bigquerytable2${uniqueId}
  friendlyName: bigquerytable-2-${uniqueId}
  datasetRef:
    name: bigquerydataset-${uniqueId}
  schema: >-
    [
      {
        "name": "data",
        "type": "STRING",
        "mode": "NULLABLE",
        "description": "The data"
      },
      {
        "name": "message_id",
        "type": "STRING",
        "mode": "REQUIRED"
      },
      {
        "name": "publish_time",
        "type": "STRING",
        "mode": "REQUIRED"
      },
      {
        "name": "attributes",
        "type": "STRING",
        "mode": "REQUIRED"
      },
      {
        "name": "subscription_name",
        "type": "STRING",
        "mode": "REQUIRED"
      }
    ]
